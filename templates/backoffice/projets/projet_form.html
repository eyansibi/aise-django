{% extends "backoffice/base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }
    .file-upload-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
    }
    .file-upload-btn {
        @apply bg-aise-green hover:bg-[#065a52] text-white px-5 py-3 rounded-xl font-medium flex items-center gap-2 transition-all transform hover:scale-105 shadow-md;
    }
    .preview-img {
        transition: all 0.3s ease;
    }
    .preview-img:hover {
        transform: scale(1.05);
    }
    .groq-btn {
        background: linear-gradient(to right, #f4ca23, #e0b61e);
        color: #1f2937;
        font-weight: 600;
    }
    .groq-btn:hover {
        background: linear-gradient(to right, #e0b61e, #f4ca23);
        transform: translateY(-1px);
    }
    .modal-backdrop {
        backdrop-filter: blur(8px);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-10">
    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8">
        <!-- Titre -->
        <h1 class="text-3xl font-bold text-text-dark mb-8 flex items-center gap-3">
            <i class="fas fa-project-diagram text-aise-green text-3xl"></i>
            {{ title }}
        </h1>

        <form method="post" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}

            <!-- Titre -->
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">
                    Titre <span class="text-red-500">*</span>
                </label>
                {{ form.titre|add_class:"w-full px-5 py-3.5 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10 transition-all text-base" }}
                {% if form.titre.errors %}
                    <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                        <i class="fas fa-exclamation-circle"></i> {{ form.titre.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <!-- Description + Bouton Groq -->
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">
                    Description <span class="text-red-500">*</span>
                </label>
                <div class="flex gap-3 mb-3">
                    {{ form.description|add_class:"w-full px-5 py-3.5 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10 transition-all text-base resize-none" }}
                    <button type="button" onclick="generateDescription(event)"
                            class="groq-btn px-5 py-3.5 rounded-xl flex items-center gap-2 shadow-md whitespace-nowrap">
                        <i class="fas fa-magic"></i> Groq AI
                    </button>
                </div>
                {% if form.description.errors %}
                    <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                        <i class="fas fa-exclamation-circle"></i> {{ form.description.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <!-- Image -->
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">
                    Image du projet
                </label>
                <div class="flex items-center gap-4">
                    <div class="file-upload-wrapper">
                        <label for="{{ form.image.id_for_label }}" class="file-upload-btn cursor-pointer">
                            <i class="fas fa-cloud-upload-alt"></i> Choisir une image
                        </label>
                        {{ form.image }}
                    </div>
                    <span class="text-xs text-text-medium italic">JPG, PNG • Max 5 Mo</span>
                </div>

                <!-- Aperçu actuel -->
                {% if form.instance.image %}
                <div class="mt-4">
                    <p class="text-sm font-medium text-text-dark mb-2">Image actuelle :</p>
                    <img src="{{ form.instance.image.url }}" alt="Aperçu" class="w-40 h-40 object-cover rounded-xl shadow-md preview-img">
                </div>
                {% endif %}

                {% if form.image.errors %}
                    <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                        <i class="fas fa-exclamation-circle"></i> {{ form.image.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <!-- Statut -->
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">Statut</label>
                {{ form.statut|add_class:"w-full px-5 py-3.5 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10 transition-all text-base" }}
            </div>

            <!-- Boutons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-8 border-t-2 border-gray-100">
                <button type="submit"
                        class="bg-gradient-to-r from-aise-green to-[#065a52] hover:from-[#065a52] hover:to-aise-green text-white px-8 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
                    <i class="fas fa-save"></i>
                    Enregistrer
                </button>
                <a href="{% url 'projets:backoffice_projets' %}"
                   class="bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-text-dark px-8 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all transform hover:scale-105 shadow-md">
                    <i class="fas fa-arrow-left"></i>
                    Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<!-- MODAL GROQ -->
<div id="suggestionsModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-auto p-8 animate-fadeIn">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-text-dark flex items-center gap-2">
                <i class="fas fa-robot text-aise-yellow"></i> Suggestions Groq AI
            </h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="suggestionsList" class="space-y-4 mb-6 max-h-96 overflow-y-auto"></div>

        <div class="flex gap-3">
            <button onclick="selectDescription(0)" class="flex-1 bg-aise-green hover:bg-[#065a52] text-white py-3 rounded-xl font-semibold transition-all transform hover:scale-105">
                Choisir la 1ère
            </button>
            <button onclick="selectDescription(1)" class="flex-1 bg-aise-yellow hover:bg-[#e0b61e] text-text-dark py-3 rounded-xl font-semibold transition-all transform hover:scale-105">
                Choisir la 2ème
            </button>
            <button onclick="selectDescription(2)" class="flex-1 bg-gradient-to-r from-aise-green to-aise-yellow text-white py-3 rounded-xl font-bold transition-all transform hover:scale-105">
                Choisir la 3ème
            </button>
        </div>
    </div>
</div>

<script>
    let suggestions = [];

    function getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }

    function generateDescription(e) {
        e.preventDefault();
        const titre = document.querySelector('input[name="titre"]').value.trim();
        if (!titre) {
            alert("Veuillez entrer un titre.");
            return;
        }

        const btn = e.target;
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
        btn.disabled = true;

        fetch("{% url 'projets:generate_description' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ titre: titre })
        })
        .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t); }))
        .then(data => {
            if (data.error) throw new Error(data.error);
            suggestions = data.descriptions || [];
            if (suggestions.length === 0) throw new Error("Aucune suggestion.");
            showModal();
        })
        .catch(err => {
            console.error(err);
            alert("Erreur : " + (err.message || "Impossible de générer."));
        })
        .finally(() => {
            btn.innerHTML = original;
            btn.disabled = false;
        });
    }

    function showModal() {
        const modal = document.getElementById('suggestionsModal');
        const list = document.getElementById('suggestionsList');
        list.innerHTML = '';

        suggestions.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'p-5 bg-gradient-to-r from-aise-yellow/5 to-white rounded-xl border-l-4 border-aise-yellow shadow-sm';
            div.innerHTML = `
                <p class="text-sm leading-relaxed text-text-dark"><strong>${i+1}.</strong> ${s.replace(/\n/g, '<br>')}</p>
            `;
            list.appendChild(div);
        });

        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('suggestionsModal').classList.add('hidden');
    }

    function selectDescription(index) {
        const textarea = document.querySelector('textarea[name="description"]');
        if (textarea && suggestions[index]) {
            textarea.value = suggestions[index];
        }
        closeModal();
    }

    // Animation d'entrée
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}