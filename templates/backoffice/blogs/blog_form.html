{% extends "backoffice/base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .groq-btn {
        background: linear-gradient(to right, #f4ca23, #e0b61e);
        color: #1f2937;
        font-weight: 600;
    }
    .groq-btn:hover {
        background: linear-gradient(to right, #e0b61e, #f4ca23);
        transform: translateY(-1px);
    }
    .modal-backdrop {
        backdrop-filter: blur(8px);
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto mt-10">
    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8">
        <!-- Titre -->
        <h1 class="text-3xl font-bold text-text-dark mb-8 flex items-center gap-3">
            <i class="fas fa-pen-fancy text-aise-green text-3xl"></i>
            {{ title }}
        </h1>

        <form method="post" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}

            <!-- Titre + Bouton IA -->
            <div>
                <div class="flex gap-3 mb-3">
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-text-dark mb-2">
                            Titre <span class="text-red-500">*</span>
                        </label>
                        {{ form.titre|add_class:"w-full px-5 py-3.5 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10 transition-all text-base" }}
                    </div>
                    <div class="self-end">
                        <button type="button" onclick="openBlogModal()"
                                class="groq-btn px-5 py-3.5 rounded-xl flex items-center gap-2 shadow-md whitespace-nowrap transition-all transform hover:scale-105">
                            <i class="fas fa-robot"></i> IA Blog
                        </button>
                    </div>
                </div>
                {% if form.titre.errors %}
                    <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                        <i class="fas fa-exclamation-circle"></i> {{ form.titre.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <!-- Contenu -->
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">
                    Contenu <span class="text-red-500">*</span>
                </label>
                {{ form.contenu|add_class:"w-full px-5 py-3.5 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10 transition-all text-base min-h-64 resize-none" }}
                {% if form.contenu.errors %}
                    <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
                        <i class="fas fa-exclamation-circle"></i> {{ form.contenu.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <!-- Image -->
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">Image</label>
                <div class="flex items-center gap-4">
                    <div class="file-upload-wrapper">
                        <label for="{{ form.image.id_for_label }}" class="bg-aise-green hover:bg-[#065a52] text-white px-5 py-3 rounded-xl font-medium flex items-center gap-2 cursor-pointer transition-all transform hover:scale-105 shadow-md">
                            <i class="fas fa-cloud-upload-alt"></i> Choisir
                        </label>
                        {{ form.image }}
                    </div>
                    <span class="text-xs text-text-medium italic">JPG, PNG • Max 5 Mo</span>
                </div>
                {% if form.instance.image %}
                <div class="mt-4">
                    <p class="text-sm font-medium text-text-dark mb-2">Image actuelle :</p>
                    <img src="{{ form.instance.image.url }}" alt="Aperçu" class="w-40 h-40 object-cover rounded-xl shadow-md hover:scale-105 transition-transform">
                </div>
                {% endif %}
            </div>

            <!-- Boutons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-8 border-t-2 border-gray-100">
                <button type="submit"
                        class="bg-gradient-to-r from-aise-green to-[#065a52] hover:from-[#065a52] hover:to-aise-green text-white px-8 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
                    <i class="fas fa-save"></i>
                    Enregistrer
                </button>
                <a href="{% url 'blogs:backoffice_blogs' %}"
                   class="bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-text-dark px-8 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all transform hover:scale-105 shadow-md">
                    <i class="fas fa-arrow-left"></i>
                    Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<!-- MODAL IA GROQ -->
<div id="blogModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-auto p-8 animate-fadeIn">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-text-dark flex items-center gap-2">
                <i class="fas fa-robot text-aise-yellow"></i> Générateur d’articles (Groq AI)
            </h3>
            <button onclick="closeBlogModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">Thème</label>
                <input id="themeInput" type="text" value="innovation" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10">
            </div>
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">Ton</label>
                <select id="tonSelect" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10">
                    <option value="professionnel">Professionnel</option>
                    <option value="décontracté">Décontracté</option>
                    <option value="inspirant" selected>Inspirant</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">Longueur</label>
                <select id="longueurSelect" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10">
                    <option value="court">Court (~200 mots)</option>
                    <option value="moyen" selected>Moyen (~400 mots)</option>
                    <option value="long">Long (~600 mots)</option>
                </select>
            </div>
        </div>

        <div class="flex justify-center mb-6">
            <button onclick="generateArticles()" 
                    class="bg-gradient-to-r from-aise-yellow to-[#e0b61e] hover:from-[#e0b61e] hover:to-aise-yellow text-text-dark px-8 py-4 rounded-xl font-bold text-lg flex items-center gap-3 transition-all transform hover:scale-105 shadow-lg">
                <i class="fas fa-magic"></i> Générer 3 articles
            </button>
        </div>

        <div id="articlesList" class="space-y-6 mb-6 max-h-96 overflow-y-auto"></div>
    </div>
</div>

<script>
let blogArticles = [];

function openBlogModal() {
    document.getElementById('blogModal').classList.remove('hidden');
}

function closeBlogModal() {
    document.getElementById('blogModal').classList.add('hidden');
}

function generateArticles() {
    const titre = document.querySelector('input[name="titre"]').value.trim();
    if (!titre) {
        alert("Veuillez entrer un titre d'article.");
        return;
    }

    const theme = document.getElementById('themeInput').value;
    const ton = document.getElementById('tonSelect').value;
    const longueur = document.getElementById('longueurSelect').value;

    const btn = event.target;
    const original = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération en cours...';
    btn.disabled = true;

    fetch("{% url 'blogs:generate_content' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ titre, theme, ton, longueur })
    })
    .then(r => r.ok ? r.json() : r.text().then(t => {throw new Error(t)}))
    .then(data => {
        if (data.error) throw new Error(data.error);
        blogArticles = data.articles || [];
        if (blogArticles.length === 0) throw new Error("Aucun article généré.");
        displayArticles();
    })
    .catch(err => {
        alert("Erreur IA : " + (err.message || "Impossible de générer."));
        console.error(err);
    })
    .finally(() => {
        btn.innerHTML = original;
        btn.disabled = false;
    });
}

function displayArticles() {
    const list = document.getElementById('articlesList');
    list.innerHTML = blogArticles.map((a, i) => `
        <div class="p-6 bg-gradient-to-r from-aise-yellow/5 to-white rounded-xl border-l-4 border-aise-yellow shadow-sm">
            <h4 class="text-lg font-bold text-text-dark mb-2">${a.titre}</h4>
            <p class="text-sm text-text-medium leading-relaxed line-clamp-4">${a.contenu.replace(/\n/g, '<br>')}</p>
            <button onclick="selectArticle(${i})" 
                    class="mt-4 bg-aise-green hover:bg-[#065a52] text-white px-5 py-2.5 rounded-lg font-semibold transition-all transform hover:scale-105">
                Utiliser cet article
            </button>
        </div>
    `).join('');
}

function selectArticle(index) {
    const article = blogArticles[index];
    if (article) {
        document.querySelector('input[name="titre"]').value = article.titre;
        document.querySelector('textarea[name="contenu"]').value = article.contenu;
    }
    closeBlogModal();
}
</script>
{% endblock %}