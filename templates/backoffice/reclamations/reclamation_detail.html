{% extends "backoffice/base.html" %}
{% load widget_tweaks %}

{% block page_title %}Réclamation #{{ reclamation.id }}{% endblock %}

{% block extra_head %}
<style>
    .groq-btn {
        background: linear-gradient(to right, #f4ca23, #e0b61e);
        color: #1f2937;
        font-weight: 600;
    }
    .groq-btn:hover {
        background: linear-gradient(to right, #e0b61e, #f4ca23);
        transform: translateY(-1px);
    }
    .modal-backdrop {
        backdrop-filter: blur(8px);
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto mt-10">
    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8">
        <!-- En-tête -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
            <h1 class="text-3xl font-bold text-text-dark flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-aise-yellow"></i>
                Réclamation #{{ reclamation.id }}
            </h1>
            <span class="px-5 py-2 rounded-full text-sm font-bold shadow-sm
                         {% if reclamation.statut == 'en_attente' %}bg-white text-aise-yellow border-2 border-aise-yellow/50
                         {% elif reclamation.statut == 'traite' %}bg-green-50 text-green-700 border-2 border-green-200
                         {% else %}bg-red-50 text-red-700 border-2 border-red-200{% endif %}">
                {{ reclamation.get_statut_display }}
            </span>
        </div>

        <!-- INFOS CLIENT -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 p-6 bg-gradient-to-r from-aise-green/5 to-white rounded-xl border border-aise-green/20">
            <div>
                <p class="text-sm font-semibold text-text-dark mb-1">Expéditeur</p>
                <p class="font-bold text-lg">{{ reclamation.nom }}</p>
                <p class="text-sm text-text-medium">{{ reclamation.email }}</p>
            </div>
            <div>
                <p class="text-sm font-semibold text-text-dark mb-1">Sujet</p>
                <p class="font-medium text-lg line-clamp-2">{{ reclamation.sujet }}</p>
            </div>
            <div>
                <p class="text-sm font-semibold text-text-dark mb-1">Reçue le</p>
                <p class="font-medium">{{ reclamation.date_reception|date:"d/m/Y à H:i" }}</p>
            </div>
        </div>

        <!-- MESSAGE CLIENT -->
        <div class="mb-8">
            <h3 class="text-lg font-bold text-text-dark mb-3 flex items-center gap-2">
                <i class="fas fa-comment-dots text-aise-green"></i> Message du client
            </h3>
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <p class="text-text-dark whitespace-pre-wrap leading-relaxed">{{ reclamation.message }}</p>
            </div>
        </div>

        <!-- FORMULAIRE RÉPONSE -->
        <form method="post" class="space-y-8">
            {% csrf_token %}

            <!-- Statut -->
            <div>
                <label class="block text-sm font-semibold text-text-dark mb-2">Statut</label>
                <select name="statut" class="w-full px-5 py-3.5 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10 transition-all text-base">
                    <option value="en_attente" {% if reclamation.statut == 'en_attente' %}selected{% endif %}>En attente</option>
                    <option value="traite" {% if reclamation.statut == 'traite' %}selected{% endif %}>Traité</option>
                    <option value="rejete" {% if reclamation.statut == 'rejete' %}selected{% endif %}>Rejeté</option>
                </select>
            </div>

            <!-- Réponse + Bouton Groq -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-sm font-semibold text-text-dark">Réponse à envoyer</label>
                    <button type="button" onclick="generateResponse()"
                            class="groq-btn px-5 py-3.5 rounded-xl flex items-center gap-2 shadow-md whitespace-nowrap transition-all transform hover:scale-105">
                        <i class="fas fa-robot"></i> IA Groq
                    </button>
                </div>
                <textarea name="reponse" rows="8" class="w-full px-5 py-3.5 border-2 border-gray-200 rounded-xl focus:border-aise-green focus:ring-4 focus:ring-aise-green/10 transition-all text-base resize-none placeholder:text-text-medium/50"
                          placeholder="Rédigez votre réponse ou choisissez une suggestion IA...">{{ reclamation.reponse }}</textarea>
            </div>

            <!-- Boutons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-8 border-t-2 border-gray-100">
                <button type="submit"
                        class="bg-gradient-to-r from-aise-green to-[#065a52] hover:from-[#065a52] hover:to-aise-green text-white px-8 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
                    <i class="fas fa-paper-plane"></i>
                    Enregistrer & Envoyer
                </button>
                <a href="{% url 'reclamations:backoffice_reclamations' %}"
                   class="bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-text-dark px-8 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all transform hover:scale-105 shadow-md">
                    <i class="fas fa-arrow-left"></i>
                    Retour à la liste
                </a>
            </div>
        </form>
    </div>
</div>

<!-- MODAL IA GROQ -->
<div id="responseModal" class="fixed inset-0 bg-black/50 modal-backdrop hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-auto p-8 animate-fadeIn">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-text-dark flex items-center gap-2">
                <i class="fas fa-robot text-aise-yellow"></i> Réponses suggérées (Groq AI)
            </h3>
            <button onclick="closeResponseModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="responsesList" class="space-y-5 mb-6 max-h-96 overflow-y-auto"></div>

        <div class="flex gap-3">
            <button onclick="selectResponse(0)" class="flex-1 bg-aise-green hover:bg-[#065a52] text-white py-3 rounded-xl font-semibold transition-all transform hover:scale-105">
                Choisir la 1ère
            </button>
            <button onclick="selectResponse(1)" class="flex-1 bg-aise-yellow hover:bg-[#e0b61e] text-text-dark py-3 rounded-xl font-semibold transition-all transform hover:scale-105">
                Choisir la 2ème
            </button>
            <button onclick="selectResponse(2)" class="flex-1 bg-gradient-to-r from-aise-green to-aise-yellow text-white py-3 rounded-xl font-bold transition-all transform hover:scale-105">
                Choisir la 3ème
            </button>
        </div>
    </div>
</div>

<script>
let responses = [];

function generateResponse() {
    const sujet = "{{ reclamation.sujet|escapejs }}";
    const message = "{{ reclamation.message|escapejs }}";
    const email = "{{ reclamation.email|escapejs }}";

    const modal = document.getElementById('responseModal');
    modal.classList.remove('hidden');

    fetch("{% url 'reclamations:generate_response' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ sujet, message, email })
    })
    .then(r => r.ok ? r.json() : r.text().then(t => {throw new Error(t)}))
    .then(data => {
        if (data.error) throw new Error(data.error);
        responses = data.reponses || [];
        if (responses.length === 0) throw new Error("Aucune réponse générée.");
        displayResponses();
    })
    .catch(err => {
        alert("Erreur IA : " + (err.message || "Impossible de générer."));
        closeResponseModal();
    });
}

function displayResponses() {
    const list = document.getElementById('responsesList');
    list.innerHTML = responses.map((r, i) => `
        <div class="p-5 bg-gradient-to-r from-aise-yellow/5 to-white rounded-xl border-l-4 border-aise-yellow shadow-sm">
            <p class="text-sm leading-relaxed text-text-dark whitespace-pre-wrap"><strong>${i+1}.</strong> ${r}</p>
        </div>
    `).join('');
}

function selectResponse(index) {
    const textarea = document.querySelector('textarea[name="reponse"]');
    if (textarea && responses[index]) {
        textarea.value = responses[index];
    }
    closeResponseModal();
}

function closeResponseModal() {
    document.getElementById('responseModal').classList.add('hidden');
}
</script>
{% endblock %}