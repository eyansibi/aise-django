{% extends "backoffice/base.html" %}
{% load static %}

{% block page_title %}Tableau de bord{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container { position: relative; height: 260px; }
    .badge {
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 9999px;
        color: white;
        background: linear-gradient(to right, #087065, #f4ca23);
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        animation: fadeIn 0.5s ease-out;
    }
    .count-up {
        animation: fadeInUp 0.6s ease-out;
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}

<!-- ==================== CARTES PRINCIPALES ==================== -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Utilisateurs -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
        <div class="flex items-center justify-between">
            <div class="count-up">
                <p class="text-sm text-text-medium">Utilisateurs</p>
                <p class="text-3xl font-bold text-text-dark mt-1">{{ total_users|default:"0" }}</p>
                <p class="text-xs text-aise-green mt-2 flex items-center gap-1">
                    <i class="fas fa-arrow-up"></i>
                    {{ users_growth|default:"+0%" }} ce mois
                </p>
            </div>
            <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-users text-blue-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Projets actifs -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
        <div class="flex items-center justify-between">
            <div class="count-up">
                <p class="text-sm text-text-medium">Projets actifs</p>
                <p class="text-3xl font-bold text-text-dark mt-1">{{ projets_actifs|default:"0" }}</p>
                <p class="text-xs text-aise-green mt-2 flex items-center gap-1">
                    <i class="fas fa-plus"></i>
                    {{ nouveaux_projets|default:"+0" }} nouveaux
                </p>
            </div>
            <div class="p-3 bg-aise-green/10 rounded-full">
                <i class="fas fa-folder-open text-aise-green text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Réclamations -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
        <div class="flex items-center justify-between">
            <div class="count-up">
                <p class="text-sm text-text-medium">Réclamations</p>
                <p class="text-3xl font-bold text-text-dark mt-1">{{ total_reclamations|default:"0" }}</p>
                <p class="text-xs text-orange-600 mt-2 flex items-center gap-1">
                    <i class="fas fa-clock"></i>
                    {{ reclamations_en_attente|default:"0" }} en attente
                </p>
            </div>
            <div class="p-3 bg-orange-100 rounded-full">
                <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Articles publiés -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
        <div class="flex items-center justify-between">
            <div class="count-up">
                <p class="text-sm text-text-medium">Articles publiés</p>
                <p class="text-3xl font-bold text-text-dark mt-1">{{ total_blogs|default:"0" }}</p>
                <p class="text-xs text-aise-green mt-2 flex items-center gap-1">
                    <i class="fas fa-plus"></i>
                    {{ blogs_this_month|default:"+0" }} ce mois
                </p>
            </div>
            <div class="p-3 bg-aise-yellow/20 rounded-full">
                <i class="fas fa-newspaper text-aise-yellow text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- ==================== TOP MOTS-CLÉS ==================== -->
<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-8">
    <h3 class="text-lg font-semibold text-text-dark mb-4 flex items-center gap-2">
        <i class="fas fa-tags text-aise-green"></i> Top mots dans les réclamations
    </h3>
    <div class="flex flex-wrap gap-2">
        {% for mot in top_mots_labels %}
            <span class="badge">{{ mot }}</span>
        {% empty %}
            <span class="text-text-medium text-sm italic">Aucun mot détecté</span>
        {% endfor %}
    </div>
</div>

<!-- ==================== RACCOURCIS ==================== -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <a href="{% url 'users:backoffice_users' %}" 
       class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 flex items-center justify-between">
        <div>
            <h3 class="text-lg font-semibold">Gérer les utilisateurs</h3>
            <p class="text-blue-100 text-sm mt-1">Ajouter, modifier, supprimer</p>
        </div>
        <i class="fas fa-arrow-right text-xl"></i>
    </a>

    <a href="{% url 'projets:backoffice_projets' %}" 
       class="bg-gradient-to-r from-aise-green to-[#065a52] text-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 flex items-center justify-between">
        <div>
            <h3 class="text-lg font-semibold">Projets</h3>
            <p class="text-green-100 text-sm mt-1">Suivi et validation</p>
        </div>
        <i class="fas fa-arrow-right text-xl"></i>
    </a>

    <a href="{% url 'blogs:backoffice_blogs' %}" 
       class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 flex items-center justify-between">
        <div>
            <h3 class="text-lg font-semibold">Publications</h3>
            <p class="text-orange-100 text-sm mt-1">Blog & actualités</p>
        </div>
        <i class="fas fa-arrow-right text-xl"></i>
    </a>
</div>

<!-- ==================== ACTIVITÉ RÉCENTE ==================== -->
<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
    <h3 class="text-lg font-semibold text-text-dark mb-4 flex items-center gap-2">
        <i class="fas fa-history text-aise-green"></i> Activité récente
    </h3>
    <ul class="space-y-3 text-sm text-text-medium">
        {% for activity in recent_activity %}
        <li class="flex items-center gap-3">
            <i class="fas {{ activity.icon }} {{ activity.color }} w-5 h-5"></i>
            <span>
                {{ activity.text|safe }}
                <span class="text-text-medium/70">· {{ activity.time }}</span>
            </span>
        </li>
        {% empty %}
        <li class="text-text-medium italic">Aucune activité récente.</li>
        {% endfor %}
    </ul>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // === GRAPHIQUE UTILISATEURS ===
    const usersCtx = document.getElementById('usersChart')?.getContext('2d');
    if (usersCtx) {
        new Chart(usersCtx, {
            type: 'line',
            data: {
                labels: {{ users_chart_labels|safe }},
                datasets: [{
                    label: 'Nouveaux utilisateurs',
                    data: {{ users_chart_data|safe }},
                    borderColor: '#087065',
                    backgroundColor: 'rgba(8, 112, 101, 0.08)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#087065',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', cornerRadius: 8 }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // === GRAPHIQUE RÉCLAMATIONS ===
    const recCtx = document.getElementById('reclamationsChart')?.getContext('2d');
    if (recCtx) {
        new Chart(recCtx, {
            type: 'bar',
            data: {
                labels: {{ reclamations_chart_labels|safe }},
                datasets: [{
                    label: 'Réclamations',
                    data: {{ reclamations_chart_data|safe }},
                    backgroundColor: '#f4ca23',
                    borderColor: '#e0b61e',
                    borderWidth: 1,
                    borderRadius: 8,
                    borderSkipped: false,
                    hoverBackgroundColor: '#f4ca23dd'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', cornerRadius: 8 }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
</script>
{% endblock %}