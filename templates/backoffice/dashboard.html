{% extends "backoffice/base.html" %}
{% load static %}

{% block page_title %}Tableau de bord{% endblock %}

{% block extra_head %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container { position: relative; height: 240px; }
    .badge { @apply px-3 py-1 text-xs font-medium rounded-full; }
</style>
{% endblock %}

{% block content %}

<!-- ==================== CARTES PRINCIPALES ==================== -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Utilisateurs -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Utilisateurs</p>
                <p class="text-3xl font-bold text-gray-800 mt-1">{{ total_users|default:"0" }}</p>
                <p class="text-xs text-green-600 mt-2">{{ users_growth|default:"+0%" }} ce mois</p>
            </div>
            <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-users text-blue-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Projets actifs -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Projets actifs</p>
                <p class="text-3xl font-bold text-gray-800 mt-1">{{ projets_actifs|default:"0" }}</p>
                <p class="text-xs text-green-600 mt-2">{{ nouveaux_projets|default:"+0" }} nouveaux</p>
            </div>
            <div class="p-3 bg-green-100 rounded-full">
                <i class="fas fa-folder-open text-green-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Réclamations -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Réclamations</p>
                <p class="text-3xl font-bold text-gray-800 mt-1">{{ total_reclamations|default:"0" }}</p>
                <p class="text-xs text-orange-600 mt-2">{{ reclamations_en_attente|default:"0" }} en attente</p>
            </div>
            <div class="p-3 bg-orange-100 rounded-full">
                <i class="fas fa-envelope text-orange-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Articles publiés -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Articles publiés</p>
                <p class="text-3xl font-bold text-gray-800 mt-1">{{ total_blogs|default:"0" }}</p>
                <p class="text-xs text-green-600 mt-2">{{ blogs_this_month|default:"+0" }} ce mois</p>
            </div>
            <div class="p-3 bg-purple-100 rounded-full">
                <i class="fas fa-newspaper text-purple-600 text-xl"></i>
            </div>
        </div>
    </div>
</div>


<!-- ==================== NOUVELLES STATS INTELLIGENTES ==================== -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Résolution moyenne -->
    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white rounded-xl shadow-sm p-6 hover:shadow-lg transition">
        <p class="text-sm opacity-90">Résolution moyenne</p>
        <p class="text-3xl font-bold mt-1">{{ avg_resolution_days|default:"0" }} <span class="text-sm">jours</span></p>
        <p class="text-xs mt-2">Objectif < 5 jours</p>
    </div>

    <!-- Satisfaction IA -->
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl shadow-sm p-6 hover:shadow-lg transition">
        <p class="text-sm opacity-90">Satisfaction estimée (IA)</p>
        <p class="text-3xl font-bold mt-1">{{ satisfaction_score|default:"0" }}/10</p>
        <p class="text-xs mt-2">Rapidité + volume</p>
    </div>

    <!-- Projets à risque -->
    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl shadow-sm p-6 hover:shadow-lg transition">
        <p class="text-sm opacity-90">Projets à risque</p>
        <p class="text-3xl font-bold mt-1">{{ projets_a_risque|default:"0" }}</p>
        <p class="text-xs mt-2">Retard > 7 jours</p>
    </div>

    <!-- Prédiction -->
    <div class="bg-gradient-to-br from-teal-500 to-teal-600 text-white rounded-xl shadow-sm p-6 hover:shadow-lg transition">
        <p class="text-sm opacity-90">Prédiction mois prochain</p>
        <p class="text-3xl font-bold mt-1">~{{ prediction_reclamations|default:"0" }}</p>
        <p class="text-xs mt-2">réclamations</p>
    </div>
</div>

<!-- ==================== TOP MOTS-CLÉS ==================== -->
<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-3">Top mots dans les réclamations</h3>
    <div class="flex flex-wrap gap-2">
        {% for mot in top_mots_labels %}
            <span class="px-3 py-1 text-xs font-medium rounded-full bg-gradient-to-r from-blue-500 to-blue-600 text-white">{{ mot }}</span>
        {% empty %}
            <span class="text-gray-500 text-sm">Aucun mot détecté</span>
        {% endfor %}
    </div>
</div>
<!-- ==================== RACCOURCIS ==================== -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <a href="{% url 'users:backoffice_users' %}" 
       class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold">Gérer les utilisateurs</h3>
                <p class="text-blue-100 text-sm mt-1">Ajouter, modifier, supprimer</p>
            </div>
            <i class="fas fa-arrow-right text-xl"></i>
        </div>
    </a>

    <a href="{% url 'projets:backoffice_projets' %}" 
       class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold">Projets</h3>
                <p class="text-green-100 text-sm mt-1">Suivi et validation</p>
            </div>
            <i class="fas fa-arrow-right text-xl"></i>
        </div>
    </a>

    <a href="{% url 'blogs:backoffice_blogs' %}" 
       class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold">Publications</h3>
                <p class="text-purple-100 text-sm mt-1">Blog & actualités</p>
            </div>
            <i class="fas fa-arrow-right text-xl"></i>
        </div>
    </a>
</div>
<!-- ==================== COMPARAISON CROISSANCE ==================== -->
{% if croissance_leader %}
<div class="bg-gradient-to-r from-green-500 to-teal-600 text-white p-6 rounded-xl shadow-lg mb-8">
    <h3 class="text-lg font-semibold">Croissance du mois</h3>
    <p class="text-2xl font-bold mt-2">
        {{ croissance_leader }} en tête
        {% if croissance_diff %} <span class="text-green-200">({{ croissance_diff }})</span>{% endif %}
    </p>
</div>
{% endif %}

<!-- ==================== GRAPHIQUES CHART.JS ==================== -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Utilisateurs par mois -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Évolution des utilisateurs</h3>
        <div class="chart-container">
            <canvas id="usersChart"></canvas>
        </div>
    </div>

    <!-- Réclamations par mois -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Évolution des réclamations</h3>
        <div class="chart-container">
            <canvas id="reclamationsChart"></canvas>
        </div>
    </div>
</div>



<!-- ==================== ACTIVITÉ RÉCENTE ==================== -->
<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Activité récente</h3>
    <ul class="space-y-3 text-sm text-gray-600">
        {% for activity in recent_activity %}
        <li class="flex items-center gap-3">
            <i class="fas {{ activity.icon }} {{ activity.color }}"></i>
            <span>
                {{ activity.text|safe }}
                <span class="text-gray-400">à {{ activity.time }}</span>
            </span>
        </li>
        {% empty %}
        <li class="text-gray-500">Aucune activité récente.</li>
        {% endfor %}
    </ul>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // === CHART UTILISATEURS ===
    const usersCtx = document.getElementById('usersChart').getContext('2d');
    new Chart(usersCtx, {
        type: 'line',
        data: {
            labels: {{ users_chart_labels|safe }},
            datasets: [{
                label: 'Nouveaux utilisateurs',
                data: {{ users_chart_data|safe }},
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // === CHART RÉCLAMATIONS ===
    const recCtx = document.getElementById('reclamationsChart').getContext('2d');
    new Chart(recCtx, {
        type: 'bar',
        data: {
            labels: {{ reclamations_chart_labels|safe }},
            datasets: [{
                label: 'Réclamations',
                data: {{ reclamations_chart_data|safe }},
                backgroundColor: '#FB923C',
                borderRadius: 6
            }]
        },
        options:{ responsive: true, maintainAspectRatio: false }
    });
</script>
{% endblock %}